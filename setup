#!/bin/bash

scriptdir="$(cd "$(dirname "$0")" && pwd -P)"
PATH="$scriptdir/scripts:$PATH"

# shellcheck source=./components/common.sh
. "$scriptdir/components/common.sh" || exit 1

set -euo pipefail

if [ "$(id -u)" = "0" ]; then
    die "Error: Do not run as root, this script is for user setup"
fi

if [ -z "$HOMEBREW_PREFIX" ]; then
    die "HOMEBREW_PREFIX must be set or unset, not the empty string"
fi

if [ -n "$OS" ] && [ -e "$scriptdir/components/$OS/setup" ]; then
    # shellcheck disable=SC1090
    . "$scriptdir/components/$OS/setup"
else
    msg "WARNING: unrecognized or unsupported operating system"
fi

if command -v nix-env >/dev/null 2>&1; then
    msg "Applying Nix Home Manager configuration"
    "$scriptdir/switch.sh"
else
    msg "WARNING: nix is not installed, skipping home-manager setup"
fi

if [ -n "$OS" ] && [ -e "$scriptdir/components/$OS/post-setup" ]; then
    # shellcheck disable=SC1090
    . "$scriptdir/components/$OS/post-setup"
fi

msg "Setup complete"
